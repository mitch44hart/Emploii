<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Financial Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        /* --- Styles (Keep your existing CSS styles here) --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 15px; max-width: 1200px; margin: auto; background-color: #f5f7fa; color: #333; }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        h1 { text-align: center; margin-bottom: 25px; }
        .dashboard-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; }
        @media (min-width: 768px) { .dashboard-container { grid-template-columns: 1fr 1fr; } }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 20px; overflow: hidden; }
        svg { width: 100%; height: 300px; margin-top: 10px; display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: left; vertical-align: middle; }
        th { background-color: #3498db; color: white; font-weight: 500; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #f1f7fd; }
        .actions-cell { display: flex; gap: 8px; white-space: nowrap; }
        .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; border-radius: 4px; padding: 8px 12px; pointer-events: none; font-size: 14px; z-index: 10; white-space: nowrap; }
        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); text-align: center; }
        .stat-card h3 { margin-top: 0; color: #7f8c8d; font-size: 14px; margin-bottom: 5px; }
        .stat-card p { font-size: 22px; font-weight: bold; color: #2c3e50; margin-bottom: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #34495e; }
        input[type="text"], input[type="number"], input[type="date"], input[type="datetime-local"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.3s, box-shadow 0.2s; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap; }
        button:hover { background-color: #2980b9; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button i { font-size: 1em; }
        .btn-danger { background-color: #e74c3c; } .btn-danger:hover { background-color: #c0392b; }
        .btn-success { background-color: #2ecc71; } .btn-success:hover { background-color: #27ae60; }
        .btn-warning { background-color: #f39c12; } .btn-warning:hover { background-color: #e67e22; }
        .btn-secondary { background-color: #95a5a6; } .btn-secondary:hover { background-color: #7f8c8d; }
        .filter-section { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 25px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
        .filter-section .form-group { flex: 1 1 180px; margin-bottom: 0; }
        .filter-section button { flex-shrink: 0; }
        .chart-title { text-align: center; font-weight: 500; color: #34495e; margin-bottom: 15px; }
        .tabs { display: flex; flex-wrap: wrap; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; color: #7f8c8d; transition: border-color 0.3s, color 0.3s; white-space: nowrap; }
        .tab:hover { color: #3498db; }
        .tab.active { border-bottom: 3px solid #3498db; font-weight: 500; color: #34495e; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        .modal-header { padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #2c3e50; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; line-height: 1; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-footer { padding-top: 20px; border-top: 1px solid #eee; margin-top: 25px; text-align: right; }
        .modal-footer button { margin-left: 10px; }
        #notification-area { position: fixed; top: 10px; right: 10px; z-index: 1000; width: 300px; }
        .notification { padding: 10px 20px; margin: 5px 0; border-radius: 5px; color: white; opacity: 1; transition: opacity 0.5s ease-out, transform 0.3s ease-out; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: translateX(0); }
        .notification.success { background-color: #2ecc71; } .notification.error { background-color: #e74c3c; } .notification.info { background-color: #3498db; }
        .notification.fade-out { opacity: 0; transform: translateX(20px); }
        /* Styles for Auth Area */
        #auth-container { text-align: center; margin: 40px 0; }
        #user-info { margin-bottom: 15px; font-size: 16px; color: #555; }
        #user-info img { width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
        #main-content { display: none; /* Hidden initially */ }
        #loading-indicator { text-align: center; padding: 30px; font-size: 18px; color: #555; }
    </style>
</head>
<body>
    <h1>Firebase Financial Dashboard</h1>

    <div id="auth-container">
        <div id="user-info" style="display: none;">
            <img id="user-photo" src="" alt="User photo">
            <span id="user-name"></span> |
            <button id="sign-out-button" class="btn-secondary"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
        </div>
        <button id="sign-in-button"><i class="fab fa-google"></i> Sign in with Google</button>
    </div>

    <div id="main-content">
        <div id="loading-indicator">Loading data...</div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')" role="tab" aria-selected="true" aria-controls="dashboard-tab" id="dashboard-nav">Dashboard</div>
            <div class="tab" onclick="switchTab('data-entry')" role="tab" aria-selected="false" aria-controls="data-entry-tab" id="data-entry-nav">Data Entry</div>
            <div class="tab" onclick="switchTab('settings')" role="tab" aria-selected="false" aria-controls="settings-tab" id="settings-nav">Settings</div>
        </div>

        <div id="dashboard-tab" class="tab-content active" role="tabpanel" aria-labelledby="dashboard-nav">
            <div class="summary-stats">
                <div class="stat-card"> <h3>Total Amount</h3> <p id="totalAmount">$0.00</p> </div>
                <div class="stat-card"> <h3>Average per Entry</h3> <p id="averageAmount">$0.00</p> </div>
                <div class="stat-card"> <h3>Categories</h3> <p id="categoryCount">0</p> </div>
                <div class="stat-card"> <h3>Entries</h3> <p id="entryCount">0</p> </div>
            </div>
            <div class="filter-section card">
                <div class="form-group"> <label for="startDate">Start Date</label> <input type="date" id="startDate" aria-label="Filter start date"> </div>
                <div class="form-group"> <label for="endDate">End Date</label> <input type="date" id="endDate" aria-label="Filter end date"> </div>
                <div class="form-group"> <label for="categoryFilter">Category</label> <select id="categoryFilter" aria-label="Filter category"> <option value="">All Categories</option> </select> </div>
                <button type="button" onclick="applyFiltersAndDraw()"> <i class="fas fa-filter"></i> Apply Filters </button>
            </div>
            <div class="dashboard-container">
                <div class="card"> <div class="chart-title">Spending by Category</div> <svg id="barChart" role="img" aria-label="Bar chart showing spending by category"></svg> </div>
                <div class="card"> <div class="chart-title">Spending Distribution</div> <svg id="pieChart" role="img" aria-label="Pie chart showing spending distribution by category"></svg> </div>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <h2 style="margin: 0;">Transaction History</h2>
                    </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead> <tr> <th>Date</th> <th>Category</th> <th>Amount</th> <th>Notes</th> <th>Actions</th> </tr> </thead>
                        <tbody id="entryTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="data-entry-tab" class="tab-content" role="tabpanel" aria-labelledby="data-entry-nav">
            <div class="card">
                <h2>Add New Entry</h2>
                <form id="addDataForm">
                    <div class="form-group"> <label for="entryDate">Date & Time</label> <input type="datetime-local" id="entryDate" required aria-required="true"> </div>
                    <div class="form-group"> <label for="category">Category</label> <input type="text" id="category" list="categories" placeholder="Enter or select category" required aria-required="true"> <datalist id="categories"></datalist> </div>
                    <div class="form-group"> <label for="amount">Amount</label> <input type="number" id="amount" placeholder="0.00" step="0.01" required aria-required="true"> </div>
                    <div class="form-group"> <label for="notes">Notes</label> <input type="text" id="notes" placeholder="Optional notes"> </div>
                    <button type="submit" class="btn-success"> <i class="fas fa-plus"></i> Add Entry </button>
                </form>
            </div>
        </div>

        <div id="settings-tab" class="tab-content" role="tabpanel" aria-labelledby="settings-nav">
            <div class="card">
                <h2>Settings</h2>
                <div class="form-group"> <label for="currencySymbol">Currency Symbol</label> <input type="text" id="currencySymbol" value="$" maxlength="3" aria-label="Currency symbol"> </div>
                <div class="form-group"> <label for="defaultDateRange">Default Date Range</label> <select id="defaultDateRange" aria-label="Default date range"> <option value="7">Last 7 days</option> <option value="30" selected>Last 30 days</option> <option value="90">Last 90 days</option> <option value="365">Last year</option> <option value="0">All time</option> </select> </div>
                <button onclick="saveSettings()" class="btn-success"> <i class="fas fa-save"></i> Save Settings </button>
                <button onclick="clearAllData()" class="btn-danger" style="margin-left: 10px;"> <i class="fas fa-trash"></i> Clear All Entries </button>
            </div>
        </div>

        <div id="editModal" class="modal" aria-modal="true" role="dialog" aria-labelledby="editModalTitle">
            <div class="modal-content">
                <div class="modal-header"> <h2 id="editModalTitle">Edit Entry</h2> <span class="close-button" onclick="closeModal()" aria-label="Close">&times;</span> </div>
                <form id="editDataForm">
                    <input type="hidden" id="editEntryId"> <div class="form-group"> <label for="editEntryDate">Date & Time</label> <input type="datetime-local" id="editEntryDate" required aria-required="true"> </div>
                    <div class="form-group"> <label for="editCategory">Category</label> <input type="text" id="editCategory" list="categories" placeholder="Enter or select category" required aria-required="true"> </div>
                    <div class="form-group"> <label for="editAmount">Amount</label> <input type="number" id="editAmount" placeholder="0.00" step="0.01" required aria-required="true"> </div>
                    <div class="form-group"> <label for="editNotes">Notes</label> <input type="text" id="editNotes" placeholder="Optional notes"> </div>
                    <div class="modal-footer"> <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button> <button type="submit" class="btn-success"> <i class="fas fa-save"></i> Save Changes </button> </div>
                </form>
            </div>
        </div>
    </div> <div id="notification-area"></div>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your project's Firebase configuration object
        const firebaseConfig = {
    apiKey: "AIzaSyBR5uHjAAqVWgaK0RgLrp7U-uszq0Fd_c0",
    authDomain: "timetracker-33160.firebaseapp.com",
    databaseURL: "https://timetracker-33160-default-rtdb.firebaseio.com",
    projectId: "timetracker-33160",
    storageBucket: "timetracker-33160.firebasestorage.app",
    messagingSenderId: "1032295002006",
    appId: "1:1032295002006:web:3e8e65afe11449d129b7b7",
    measurementId: "G-LC81C3CF06"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        // --- Global Variables ---
        let currentUser = null;
        let currencySymbol = "$";
        let defaultDateRange = "30";
        let allEntries = []; // Local cache of user's entries from Firebase

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // UI Elements
        const authContainer = document.getElementById('auth-container');
        const userInfoDiv = document.getElementById('user-info');
        const userNameSpan = document.getElementById('user-name');
        const userPhotoImg = document.getElementById('user-photo');
        const signInButton = document.getElementById('sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const mainContentDiv = document.getElementById('main-content');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Authentication ---
        signInButton.addEventListener('click', signInWithGoogle);
        signOutButton.addEventListener('click', signOutUser);

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            fbAuth.signInWithPopup(provider)
                .then((result) => {
                    console.log("Signed in successfully:", result.user);
                    // Auth state change will handle UI updates
                })
                .catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    showNotification(`Sign-in failed: ${error.message}`, "error");
                });
        }

        function signOutUser() {
            fbAuth.signOut()
                .then(() => {
                    console.log("Signed out successfully.");
                    // Auth state change will handle UI updates
                })
                .catch((error) => {
                    console.error("Sign Out Error:", error);
                    showNotification(`Sign-out failed: ${error.message}`, "error");
                });
        }

        // Auth State Listener
        fbAuth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                currentUser = user;
                userNameSpan.textContent = user.displayName || user.email;
                userPhotoImg.src = user.photoURL || 'placeholder.png'; // Provide a placeholder image path
                userInfoDiv.style.display = 'block';
                signInButton.style.display = 'none';
                mainContentDiv.style.display = 'block';
                authContainer.style.marginBottom = '10px'; // Adjust spacing
                initAppForUser(); // Initialize data loading for the logged-in user
            } else {
                // User is signed out
                currentUser = null;
                allEntries = []; // Clear local cache
                userInfoDiv.style.display = 'none';
                signInButton.style.display = 'block';
                mainContentDiv.style.display = 'none';
                authContainer.style.marginBottom = '40px';
                // Clear dashboard elements if needed
                updateSummaryStats([]);
                drawBarChart([]);
                drawPieChart([]);
                updateDataTable([]);
                populateCategoryFilters(); // Clear filters
            }
        });

        // --- Initialization for Logged-In User ---
        async function initAppForUser() {
            loadingIndicator.style.display = 'block'; // Show loading
            await loadSettings(); // Load settings first
            setupEventListeners();
            await loadAndDisplayData(); // Load entries and draw dashboard
            loadingIndicator.style.display = 'none'; // Hide loading
        }

        // --- Settings Management (Firebase) ---
        async function loadSettings() {
            if (!currentUser) return;
            const settingsRef = fbDb.ref(`users/${currentUser.uid}/settings`);
            try {
                const snapshot = await settingsRef.once('value');
                const settings = snapshot.val();
                currencySymbol = settings?.currencySymbol || "$";
                defaultDateRange = settings?.defaultDateRange || "30";
                document.getElementById("currencySymbol").value = currencySymbol;
                document.getElementById("defaultDateRange").value = defaultDateRange;
                setDefaultDateRange(); // Apply default date range to filters
            } catch (error) {
                console.error("Error loading settings from Firebase:", error);
                showNotification("Could not load settings.", "error");
                // Use defaults if loading fails
                currencySymbol = "$";
                defaultDateRange = "30";
                setDefaultDateRange();
            }
        }

        async function saveSettings() {
            if (!currentUser) return;
            currencySymbol = document.getElementById("currencySymbol").value.trim() || "$";
            defaultDateRange = document.getElementById("defaultDateRange").value;
            const settingsRef = fbDb.ref(`users/${currentUser.uid}/settings`);
            try {
                await settingsRef.update({ // Use update to avoid overwriting other potential settings
                    currencySymbol: currencySymbol,
                    defaultDateRange: defaultDateRange
                });
                showNotification("Settings saved successfully!", "success");
                // Re-apply filters and redraw if settings affect display (like currency)
                applyFiltersAndDraw();
            } catch (error) {
                console.error("Error saving settings to Firebase:", error);
                showNotification("Error saving settings.", "error");
            }
        }

        function setDefaultDateRange() {
             const days = parseInt(defaultDateRange);
             const endDateInput = document.getElementById("endDate");
             const startDateInput = document.getElementById("startDate");
             if (!endDateInput || !startDateInput) return;
             const today = new Date();
             const formatDate = (date) => date.toISOString().split('T')[0];
             endDateInput.value = formatDate(today);
             if (days > 0) {
                 const startDate = new Date();
                 startDate.setDate(today.getDate() - days);
                 startDateInput.value = formatDate(startDate);
             } else {
                 startDateInput.value = ""; // For "All time"
             }
         }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
             // Prevent duplicate listeners if initAppForUser is called multiple times
            const addForm = document.getElementById('addDataForm');
            const editForm = document.getElementById('editDataForm');
            const closeBtn = document.querySelector('.close-button');

            if (!addForm.hasAttribute('data-listener-set')) {
                addForm.addEventListener('submit', handleAddEntry);
                addForm.setAttribute('data-listener-set', 'true');
            }
            if (!editForm.hasAttribute('data-listener-set')) {
                editForm.addEventListener('submit', handleUpdateEntry);
                editForm.setAttribute('data-listener-set', 'true');
            }
             if (!closeBtn.hasAttribute('data-listener-set')) {
                 closeBtn.addEventListener('click', closeModal);
                 closeBtn.setAttribute('data-listener-set', 'true');

                 window.addEventListener('click', (event) => {
                    const modal = document.getElementById('editModal');
                    if (event.target == modal) closeModal();
                 });
                 document.addEventListener('keydown', (event) => {
                    if (event.key === "Escape" && document.getElementById('editModal').style.display === "block") closeModal();
                 });
            }
        }

        // --- CRUD Operations (Firebase) ---
        async function handleAddEntry(event) {
            event.preventDefault();
            if (!currentUser) return;

            const categoryInput = document.getElementById('category');
            const amountInput = document.getElementById('amount');
            const notesInput = document.getElementById('notes');
            const dateInput = document.getElementById('entryDate');
            const category = categoryInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const notes = notesInput.value.trim();
            let entryDate = dateInput.value;

            if (!category || isNaN(amount) || amount <= 0) {
                showNotification("Please enter a valid category and positive amount.", "error"); return;
            }
            if (!entryDate) { /* Set default date if needed */
                const now = new Date();
                const year = now.getFullYear(); const month = (now.getMonth() + 1).toString().padStart(2, '0'); const day = now.getDate().toString().padStart(2, '0'); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0');
                entryDate = `${year}-${month}-${day}T${hours}:${minutes}`;
                dateInput.value = entryDate;
            }

            const newEntryData = {
                 date: new Date(entryDate).toISOString(),
                 category, amount, notes
                 // No need to add userId here, it's part of the path
            };

            const entriesRef = fbDb.ref(`users/${currentUser.uid}/entries`);
            const newEntryRef = entriesRef.push(); // Generate unique key

            try {
                await newEntryRef.set(newEntryData);
                categoryInput.value = ''; amountInput.value = ''; notesInput.value = ''; dateInput.value = '';
                showNotification("Entry added successfully!", "success");
                await loadAndDisplayData(); // Reload data and update dashboard
                switchTab('dashboard');
            } catch (error) {
                console.error("Error adding entry to Firebase:", error);
                showNotification("Error adding entry.", "error");
            }
        }

        async function deleteEntry(entryId) { // entryId is the Firebase key
            if (!currentUser || !entryId) return;
            if (confirm('Are you sure you want to delete this entry?')) {
                const entryRef = fbDb.ref(`users/${currentUser.uid}/entries/${entryId}`);
                try {
                    await entryRef.remove();
                    showNotification("Entry deleted.", "success");
                    await loadAndDisplayData(); // Reload data and update dashboard
                } catch (error) {
                    console.error("Error deleting entry from Firebase:", error);
                    showNotification("Error deleting entry.", "error");
                }
            }
        }

        async function handleUpdateEntry(event) {
            event.preventDefault();
            if (!currentUser) return;

            const entryId = document.getElementById('editEntryId').value; // Firebase key
            const date = document.getElementById('editEntryDate').value;
            const category = document.getElementById('editCategory').value.trim();
            const amount = parseFloat(document.getElementById('editAmount').value);
            const notes = document.getElementById('editNotes').value.trim();

            if (!entryId || !category || isNaN(amount) || amount <= 0 || !date) {
                showNotification("Please fill in all required fields with valid data.", "error"); return;
            }

            const updatedData = {
                 date: new Date(date).toISOString(), category, amount, notes
            };
            const entryRef = fbDb.ref(`users/${currentUser.uid}/entries/${entryId}`);

            try {
                await entryRef.update(updatedData);
                closeModal();
                showNotification("Entry updated successfully!", "success");
                await loadAndDisplayData(); // Reload data and update dashboard
            } catch (error) {
                console.error("Error updating entry in Firebase:", error);
                showNotification("Error updating entry.", "error");
            }
        }

        // --- Modal Management ---
        async function openEditModal(entryId) { // entryId is the Firebase key
             if (!currentUser || !entryId) return;
             const entryRef = fbDb.ref(`users/${currentUser.uid}/entries/${entryId}`);
             try {
                 const snapshot = await entryRef.once('value');
                 const entry = snapshot.val();
                 if (!entry) { showNotification("Entry not found.", "error"); return; }

                 document.getElementById('editEntryId').value = entryId; // Store the key
                 document.getElementById('editEntryDate').value = entry.date.substring(0, 16);
                 document.getElementById('editCategory').value = entry.category;
                 document.getElementById('editAmount').value = entry.amount;
                 document.getElementById('editNotes').value = entry.notes;
                 document.getElementById('editModal').style.display = 'block';
                 document.getElementById('editEntryDate').focus();
             } catch (error) {
                 console.error("Error fetching entry for edit from Firebase:", error);
                 showNotification("Could not load entry data for editing.", "error");
             }
         }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // --- Data Handling & UI Updates (Firebase) ---
        async function loadAndDisplayData() {
             if (!currentUser) { allEntries = []; applyFiltersAndDraw(); return; } // Clear if no user

             loadingIndicator.style.display = 'block';
             const entriesRef = fbDb.ref(`users/${currentUser.uid}/entries`);
             try {
                 const snapshot = await entriesRef.once('value');
                 const entriesData = snapshot.val();
                 // Convert Firebase object to array, adding the key as 'id'
                 allEntries = entriesData ? Object.keys(entriesData).map(key => ({
                     id: key, // Store the Firebase key
                     ...entriesData[key]
                 })) : [];
                console.log("Loaded entries: ", allEntries.length);
                await populateCategoryFilters(); // Update filters based on new data
                applyFiltersAndDraw(); // Filter and draw with the fresh data
             } catch (error) {
                console.error("Error loading entries from Firebase:", error);
                showNotification("Error loading transaction data.", "error");
                allEntries = []; // Clear cache on error
                applyFiltersAndDraw(); // Attempt to draw empty state
             } finally {
                 loadingIndicator.style.display = 'none';
             }
         }

        // Apply filters to the locally cached `allEntries` array and redraw
        function applyFiltersAndDraw() {
             const startDateInput = document.getElementById("startDate");
             const endDateInput = document.getElementById("endDate");
             const categoryFilterValue = document.getElementById("categoryFilter").value;

             const startDate = startDateInput.value ? new Date(startDateInput.value + "T00:00:00").toISOString() : null;
             const endDate = endDateInput.value ? new Date(endDateInput.value + "T23:59:59").toISOString() : null;

             const filteredData = allEntries.filter(entry => {
                 let include = true;
                 if (startDate && entry.date < startDate) include = false;
                 if (endDate && entry.date > endDate) include = false;
                 if (categoryFilterValue && entry.category !== categoryFilterValue) include = false;
                 return include;
             }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort after filtering

             console.log("Filtered entries: ", filteredData.length);

             updateSummaryStats(filteredData);
             drawBarChart(filteredData);
             drawPieChart(filteredData);
             updateDataTable(filteredData);
         }

        async function populateCategoryFilters() {
            // Populate based on the `allEntries` array
            const categories = [...new Set(allEntries.map(entry => entry.category))].sort();

            const categoryFilter = document.getElementById('categoryFilter');
            const categoriesDatalist = document.getElementById('categories');
            const currentFilterValue = categoryFilter.value; // Preserve selection if possible

            // Clear existing options (keep "All Categories")
            while (categoryFilter.options.length > 1) categoryFilter.remove(1);
            categoriesDatalist.innerHTML = '';

            categories.forEach(category => {
                 if (category) { // Ensure category is not empty/null
                     const filterOption = document.createElement('option');
                     filterOption.value = category; filterOption.textContent = category;
                     categoryFilter.appendChild(filterOption);

                     const datalistOption = document.createElement('option');
                     datalistOption.value = category;
                     categoriesDatalist.appendChild(datalistOption);
                 }
             });

             // Restore previous selection if the category still exists
             categoryFilter.value = Array.from(categoryFilter.options).some(opt => opt.value === currentFilterValue) ? currentFilterValue : "";
        }


        async function clearAllData() {
             if (!currentUser) return;
             if (confirm('WARNING: This will permanently delete ALL your transaction entries from Firebase. Are you sure?')) {
                 const entriesRef = fbDb.ref(`users/${currentUser.uid}/entries`);
                 try {
                     await entriesRef.remove();
                     showNotification("All entries cleared.", "success");
                     await loadAndDisplayData(); // Reload (should be empty) and redraw
                 } catch (error) {
                     console.error("Error clearing data from Firebase:", error);
                     showNotification("Error clearing data.", "error");
                 }
             }
         }

        // --- Chart Drawing & Data Update (Mostly Unchanged, ensure they use filteredData) ---
        // Make sure these functions receive the filtered data array from applyFiltersAndDraw

        function updateSummaryStats(filteredData) { /* Keep original logic */
            const total = d3.sum(filteredData, d => d.amount); const average = filteredData.length > 0 ? total / filteredData.length : 0; const categories = new Set(filteredData.map(d => d.category)).size;
            document.getElementById("totalAmount").textContent = `${currencySymbol}${total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; document.getElementById("averageAmount").textContent = `${currencySymbol}${average.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; document.getElementById("categoryCount").textContent = categories; document.getElementById("entryCount").textContent = filteredData.length;
        }

        function drawBarChart(filteredData) { /* Keep original D3 logic */
             const svg = d3.select("#barChart"); svg.selectAll("*").remove(); if (filteredData.length === 0) { svg.append("text").attr("x", "50%").attr("y", "50%").attr("text-anchor", "middle").text("No data for selected period/category."); return; } const bounds = svg.node().getBoundingClientRect(); const margin = {top: 20, right: 20, bottom: 70, left: 60}; const width = Math.max(100, bounds.width - margin.left - margin.right); const height = Math.max(100, bounds.height - margin.top - margin.bottom); const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`); const grouped = Array.from(d3.group(filteredData, d => d.category), ([key, value]) => ({ category: key, amount: d3.sum(value, d => d.amount) })).sort((a, b) => d3.descending(a.amount, b.amount)); const x = d3.scaleBand().domain(grouped.map(d => d.category)).range([0, width]).padding(0.2); const y = d3.scaleLinear().domain([0, d3.max(grouped, d => d.amount) || 1]).nice().range([height, 0]); g.selectAll(".bar").data(grouped).enter().append("rect").attr("class", "bar").attr("x", d => x(d.category)).attr("y", d => y(d.amount)).attr("width", x.bandwidth()).attr("height", d => Math.max(0, height - y(d.amount))).attr("fill", "#3498db").on("mouseover", function(event, d) { d3.select(this).attr("fill", "#2980b9"); tooltip.transition().duration(200).style("opacity", .9); tooltip.html(`<strong>${escapeHtml(d.category)}</strong><br>${currencySymbol}${d.amount.toFixed(2)}`).style("left", `${event.pageX + 10}px`).style("top", `${event.pageY - 28}px`); }).on("mouseout", function() { d3.select(this).attr("fill", "#3498db"); tooltip.transition().duration(500).style("opacity", 0); }); g.append("g").attr("class", "x-axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").style("text-anchor", "end").attr("dx", "-.8em").attr("dy", ".15em").attr("transform", "rotate(-45)"); g.append("g").attr("class", "y-axis").call(d3.axisLeft(y).ticks(Math.min(5, height / 40)).tickFormat(d => `${currencySymbol}${d3.format(",.0f")(d)}`)); g.append("text").attr("transform", "rotate(-90)").attr("y", 0 - margin.left + 10).attr("x", 0 - (height / 2)).attr("dy", "1em").style("text-anchor", "middle").style("font-size", "12px").style("fill", "#555").text("Total Amount");
        }

        function drawPieChart(filteredData) { /* Keep original D3 logic */
             const svg = d3.select("#pieChart"); svg.selectAll("*").remove(); if (filteredData.length === 0) { svg.append("text").attr("x", "50%").attr("y", "50%").attr("text-anchor", "middle").text("No data for selected period/category."); return; } const bounds = svg.node().getBoundingClientRect(); const width = bounds.width; const height = bounds.height; const margin = {top: 20, right: 20, bottom: 20, left: 20}; const legendWidth = 100; const legendItemHeight = 20; const chartAreaWidth = width - legendWidth - margin.left - margin.right; const chartAreaHeight = height - margin.top - margin.bottom; const radius = Math.min(chartAreaWidth, chartAreaHeight) / 2 * 0.8; const g = svg.append("g").attr("transform", `translate(${margin.left + chartAreaWidth / 2}, ${margin.top + chartAreaHeight / 2})`); const grouped = Array.from(d3.group(filteredData, d => d.category), ([key, value]) => ({ category: key, amount: d3.sum(value, d => d.amount) })).filter(d => d.amount > 0); if (grouped.length === 0) { svg.append("text").attr("x", "50%").attr("y", "50%").attr("text-anchor", "middle").text("No spending data."); return; } const totalAmount = d3.sum(grouped, d => d.amount); const color = d3.scaleOrdinal().domain(grouped.map(d => d.category)).range(d3.schemeTableau10); const pie = d3.pie().value(d => d.amount).sort(null); const arc = d3.arc().innerRadius(radius * 0.4).outerRadius(radius); const arcs = g.selectAll(".arc").data(pie(grouped)).enter().append("g").attr("class", "arc"); arcs.append("path").attr("d", arc).attr("fill", d => color(d.data.category)).attr("stroke", "white").style("stroke-width", "2px").on("mouseover", function(event, d) { d3.select(this).attr("opacity", 0.7); tooltip.transition().duration(200).style("opacity", .9); const percent = (d.data.amount / totalAmount) * 100; tooltip.html(`<strong>${escapeHtml(d.data.category)}</strong><br>${currencySymbol}${d.data.amount.toFixed(2)}<br>${percent.toFixed(1)}%`).style("left", `${event.pageX + 10}px`).style("top", `${event.pageY - 28}px`); }).on("mouseout", function() { d3.select(this).attr("opacity", 1); tooltip.transition().duration(500).style("opacity", 0); }); arcs.append("text").attr("transform", d => `translate(${arc.centroid(d)})`).attr("text-anchor", "middle").style("fill", "white").style("font-size", "11px").text(d => { const percent = (d.data.amount / totalAmount) * 100; return percent > 5 ? `${Math.round(percent)}%` : ''; }); const maxLegendItems = Math.floor((chartAreaHeight) / legendItemHeight); const legendData = color.domain().slice(0, maxLegendItems); const legend = svg.append("g").attr("class", "legend").attr("transform", `translate(${width - legendWidth - margin.right}, ${margin.top})`); const legendItems = legend.selectAll(".legend-item").data(legendData).enter().append("g").attr("class", "legend-item").attr("transform", (d, i) => `translate(0, ${i * legendItemHeight})`); legendItems.append("rect").attr("width", 15).attr("height", 15).attr("fill", color); legendItems.append("text").attr("x", 20).attr("y", 12).text(d => escapeHtml(d)).style("font-size", "12px").style("fill", "#333"); if (color.domain().length > maxLegendItems) { legend.append("text").attr("x", 0).attr("y", maxLegendItems * legendItemHeight + 10).text("...").style("font-size", "12px").style("fill", "#555"); }
        }

        function updateDataTable(filteredData) { // Ensure buttons use entry.id (Firebase key)
             const tableBody = document.getElementById("entryTable");
             tableBody.innerHTML = "";
             if (filteredData.length === 0) { /* Show empty message */ const row = tableBody.insertRow(); const cell = row.insertCell(); cell.colSpan = 5; cell.textContent = "No transactions found for the selected criteria."; cell.style.textAlign = "center"; cell.style.padding = "20px"; cell.style.color = "#777"; return; }
             filteredData.forEach(entry => {
                 const row = tableBody.insertRow();
                 const dateObj = new Date(entry.date);
                 const formattedDate = dateObj.toLocaleDateString();
                 const formattedTime = dateObj.toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' });
                 row.innerHTML = `
                     <td>${formattedDate} ${formattedTime}</td>
                     <td>${escapeHtml(entry.category)}</td>
                     <td>${currencySymbol}${entry.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                     <td>${escapeHtml(entry.notes || '')}</td>
                     <td class="actions-cell">
                         <button onclick="openEditModal('${entry.id}')" class="btn-warning" title="Edit Entry"><i class="fas fa-edit"></i></button>
                         <button onclick="deleteEntry('${entry.id}')" class="btn-danger" title="Delete Entry"><i class="fas fa-trash"></i></button>
                     </td>
                 `; // Pass entry.id (Firebase key) as string
             });
         }

        // --- Utility Functions (Mostly Unchanged) ---
        function switchTab(tabName) { /* Keep original logic */
             document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.remove('active'); tab.setAttribute('aria-hidden', 'true'); }); document.querySelectorAll('.tab').forEach(tab => { tab.classList.remove('active'); tab.setAttribute('aria-selected', 'false'); tab.setAttribute('tabindex', '-1'); }); const activeContent = document.getElementById(`${tabName}-tab`); const activeTab = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`); if (activeContent) { activeContent.classList.add('active'); activeContent.setAttribute('aria-hidden', 'false'); } if (activeTab) { activeTab.classList.add('active'); activeTab.setAttribute('aria-selected', 'true'); activeTab.setAttribute('tabindex', '0'); activeTab.focus(); }
        }
        function escapeHtml(unsafe) { /* Keep original logic */
             if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        function showNotification(message, type = 'info') { /* Keep original logic */
             let notificationArea = document.getElementById('notification-area'); if (!notificationArea) { notificationArea = document.createElement('div'); notificationArea.id = 'notification-area'; document.body.appendChild(notificationArea); } const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.textContent = message; notificationArea.appendChild(notification); setTimeout(() => { notification.classList.add('fade-out'); notification.addEventListener('transitionend', () => { notification.remove(); if (!notificationArea.hasChildNodes()) notificationArea.remove(); }); }, 3000);
        }

        // --- App Initialization ---
        // Authentication listener handles the main app flow initiation
        console.log("Firebase Dashboard Initialized. Waiting for auth state...");

    </script>
</body>
</html>
